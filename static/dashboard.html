<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>순찰 로봇 관제 대시보드 (FastAPI WebSocket)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #e2e8f0; }
    .dashboard-card { background-color: #ffffff; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05); }
    .metric-value { font-size: 2.5rem; font-weight: 800; color: #1e3a8a; }
    #map-canvas { border: 2px solid #cbd5e1; image-rendering: pixelated; }
  </style>
</head>
<body class="min-h-screen p-4 md:p-8">
  <div class="max-w-7xl mx-auto">
    <header class="flex justify-between items-center mb-8 pb-4 border-b-2 border-blue-200">
      <h1 class="text-4xl font-extrabold text-gray-800">순찰 로봇 관제 대시보드</h1>
      <div class="flex items-center space-x-4">
        <div id="ws-status" class="flex items-center space-x-2 text-sm font-semibold">
          <span id="status-indicator" class="w-3 h-3 rounded-full bg-red-500"></span>
          <span id="status-text" class="text-red-700">WS 연결 중...</span>
        </div>
      </div>
    </header>

    <div class="grid grid-cols-12 gap-8">
      <!-- 왼쪽: 지도/영상 -->
      <div class="col-span-12 lg:col-span-8 space-y-8">
        <!-- 1. SLAM 지도 및 위치 -->
        <div class="dashboard-card p-6">
          <h2 class="text-2xl font-semibold text-gray-700 mb-4">SLAM 순찰 지도 및 실시간 위치</h2>
          <div id="map-container" class="relative w-full aspect-video bg-gray-100 flex items-center justify-center rounded-lg overflow-hidden">
            <canvas id="map-canvas" width="800" height="600" class="w-full h-full"></canvas>
            <p id="map-placeholder" class="absolute text-gray-500 text-center p-4">
              /map, /amcl_pose, /odom 데이터를 받아 그립니다.
            </p>
          </div>
          <div id="robot-location" class="mt-4 text-gray-600 font-medium">현재 로봇 좌표: N/A</div>
        </div>

        <!-- 2. 실시간 웹캠 -->
        <div class="dashboard-card p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-semibold text-gray-700">실시간 상황 보기 (웹캠)</h2>
            <button id="video-toggle-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">영상 시작</button>
          </div>
          <div id="video-container" class="relative w-full aspect-video bg-gray-800 flex items-center justify-center rounded-lg hidden">
            <img id="webcam-feed" alt="실시간 웹캠 피드" class="w-full h-full object-cover" />
            <p id="video-placeholder" class="absolute text-white text-lg">웹캠 스트리밍 준비 중...</p>
          </div>
        </div>
      </div>

      <!-- 오른쪽: 상태/제어 -->
      <div class="col-span-12 lg:col-span-4 space-y-6">
        <div class="dashboard-card p-6">
          <h2 class="text-2xl font-semibold text-gray-700 mb-6">로봇 실시간 상태</h2>
          <div class="bg-blue-50 p-4 rounded-lg mb-4 border border-blue-200">
            <p class="text-sm text-blue-600 font-medium">실시간 배터리 잔량</p>
            <div class="flex justify-between items-center mt-1">
              <span id="metric-battery" class="metric-value">--%</span>
              <svg class="w-10 h-10 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-1-8a1 1 0 002 0V7a1 1 0 10-2 0v3z" clip-rule="evenodd"/></svg>
            </div>
          </div>
          <div class="bg-indigo-50 p-4 rounded-lg mb-4 border border-indigo-200">
            <p class="text-sm text-indigo-600 font-medium">순찰 거리 (누적)</p>
            <div class="flex justify-between items-center mt-1">
              <span id="metric-distance" class="metric-value">-- m</span>
              <svg class="w-10 h-10 text-indigo-500" fill="currentColor" viewBox="0 0 20 20"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 0 08 0z" clip-rule="evenodd"/></svg>
            </div>
          </div>
          <div class="bg-purple-50 p-4 rounded-lg mb-4 border border-purple-200">
            <p class="text-sm text-purple-600 font-medium">순찰 시간</p>
            <div class="flex justify-between items-center mt-1">
              <span id="metric-time" class="metric-value">-- min</span>
              <svg class="w-10 h-10 text-purple-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a 1 1 0 00.293.707l3 3a1 1 0 001.414-1.414L11 9.586V6z" clip-rule="evenodd"/></svg>
            </div>
          </div>
        </div>

        <!-- 제어 영역 -->
        <div class="dashboard-card p-6">
          <h2 class="text-2xl font-semibold text-gray-700 mb-4">로봇 제어</h2>

          <!-- 순찰 제어 버튼 -->
          <div class="grid grid-cols-4 gap-2 mb-4">
            <button data-patrol="start"  class="col-span-2 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 rounded-lg">순찰 시작</button>
            <button data-patrol="pause"  class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 rounded-lg">일시정지</button>
            <button data-patrol="return" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 rounded-lg">복귀</button>
            <button id="btn-ack" class="col-span-4 bg-rose-600 hover:bg-rose-700 text-white font-bold py-2 rounded-lg">관리자 확인(ACK)</button>
          </div>

          <!-- 속도 조절 슬라이더 -->
          <div class="mb-4 space-y-3">
            <div>
              <label class="block text-sm font-semibold text-gray-600">선속도 상한 (m/s)</label>
              <input id="slider-speed" type="range" min="0" max="0.60" step="0.01" value="0.12" class="w-full">
              <div class="text-sm text-gray-500">현재: <span id="label-speed">0.12</span> m/s</div>
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-600">회전속도 상한 (rad/s)</label>
              <input id="slider-turn" type="range" min="0" max="1.50" step="0.01" value="0.35" class="w-full">
              <div class="text-sm text-gray-500">현재: <span id="label-turn">0.35</span> rad/s</div>
            </div>
          </div>

          <!-- 수동 이동 -->
          <div class="grid grid-cols-3 gap-3">
            <button data-cmd="forward" class="col-span-3 bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 rounded-lg">전진</button>
            <button data-cmd="left" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 rounded-lg">좌회전</button>
            <button data-cmd="stop" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg">정지</button>
            <button data-cmd="right" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 rounded-lg">우회전</button>
            <button data-cmd="backward" class="col-span-3 bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 rounded-lg">후진</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ── 네트워크
    const WS_HOST = '192.168.0.51';
    const WS_PORT = 8000;
    const WS_URL  = `ws://${WS_HOST}:${WS_PORT}/ws`;

    const CAM_HOST = '192.168.0.100';
    const MJPEG_URL= `http://${CAM_HOST}:8080/stream?topic=/image_raw&type=ros_compressed&width=480&height=360&quality=35`;

    // ── WS
    let ws=null, isConnected=false;
    const statusIndicator=document.getElementById('status-indicator');
    const statusText=document.getElementById('status-text');

    function connectWS(){
      ws = new WebSocket(WS_URL);
      ws.onopen = () => {
        isConnected=true;
        statusIndicator.className='w-3 h-3 rounded-full bg-green-500';
        statusText.textContent='WS 연결됨';
        statusText.className='text-green-700';
      };
      ws.onerror = () => {
        statusIndicator.className='w-3 h-3 rounded-full bg-red-500';
        statusText.textContent='WS 오류 발생';
        statusText.className='text-red-700';
      };
      ws.onclose = () => {
        isConnected=false;
        statusIndicator.className='w-3 h-3 rounded-full bg-yellow-500';
        statusText.textContent='WS 연결 끊김 (재연결 시도)';
        statusText.className='text-yellow-700';
        setTimeout(connectWS, 2000);
      };
      ws.onmessage = (ev) => {
        const m = JSON.parse(ev.data);
        handleMessage(m);
      };
    }

    // ── 지도/상태
    const mapCanvas = document.getElementById('map-canvas');
    const mapCtx = mapCanvas.getContext('2d', { willReadFrequently: true });
    let lastOdom = null, accumDist = 0, startTime = Date.now();

    function handleMessage(m){
      if (m.type === 'amcl_pose'){
        document.getElementById('robot-location').textContent = `현재 로봇 좌표: X=${m.x} m, Y=${m.y} m, Yaw=${m.yaw}`;
      } else if (m.type === 'battery'){
        if (m.percentage != null) document.getElementById('metric-battery').textContent = `${m.percentage}%`;
      } else if (m.type === 'odom'){
        if (lastOdom){
          const dx = m.x - lastOdom.x, dy = m.y - lastOdom.y;
          accumDist += Math.hypot(dx,dy);
          document.getElementById('metric-distance').textContent = `${accumDist.toFixed(1)} m`;
          const mins = Math.max(0, Math.floor((Date.now()-startTime)/60000));
          document.getElementById('metric-time').textContent = `${mins} min`;
        }
        lastOdom = {x:m.x, y:m.y};
      } else if (m.type === 'map'){
        drawMap(m);
      } else if (m.type === 'limits'){
        sliderSpeed.value = m.max_speed.toFixed(2);
        labelSpeed.textContent = m.max_speed.toFixed(2);
        sliderTurn.value = m.max_turn.toFixed(2);
        labelTurn.textContent = m.max_turn.toFixed(2);
      }
    }

    function drawMap(m){
      const w=m.width, h=m.height, gray=m.gray;
      if (mapCanvas.width!==w || mapCanvas.height!==h){
        mapCanvas.width=w; mapCanvas.height=h;
        document.getElementById('map-placeholder')?.remove();
      }
      const imgData = mapCtx.createImageData(w,h);
      for (let i=0,j=0;i<gray.length;i++,j+=4){
        const g=gray[i]|0;
        imgData.data[j]=g; imgData.data[j+1]=g; imgData.data[j+2]=g; imgData.data[j+3]=255;
      }
      mapCtx.putImageData(imgData,0,0);
    }

    // ── 웹캠
    const videoContainer = document.getElementById('video-container');
    const webcamFeed = document.getElementById('webcam-feed');
    const videoBtn = document.getElementById('video-toggle-btn');
    const videoPlaceholder = document.getElementById('video-placeholder');
    let videoOn=false;

    videoBtn.addEventListener('click', ()=>{
      if(!videoOn){
        videoContainer.classList.remove('hidden');
        videoPlaceholder.classList.remove('hidden');
        webcamFeed.onerror = ()=>{
          videoPlaceholder.textContent='스트리밍 오류… 토픽/URL 확인';
          videoPlaceholder.classList.remove('hidden');
        };
        webcamFeed.onload = ()=>{
          videoPlaceholder.classList.add('hidden');
        };
        webcamFeed.src = MJPEG_URL;
        videoBtn.textContent='영상 중지';
        videoBtn.classList.remove('bg-green-500','hover:bg-green-600');
        videoBtn.classList.add('bg-red-500','hover:bg-red-600');
        videoOn=true;
      }else{
        webcamFeed.src='';
        videoContainer.classList.add('hidden');
        videoPlaceholder.textContent='웹캠 스트리밍 준비 중...';
        videoPlaceholder.classList.remove('hidden');
        videoBtn.textContent='영상 시작';
        videoBtn.classList.remove('bg-red-500','hover:bg-red-600');
        videoBtn.classList.add('bg-green-500','hover:bg-green-600');
        videoOn=false;
      }
    });

    // ── 속도 제한
    const sliderSpeed = document.getElementById('slider-speed');
    const sliderTurn  = document.getElementById('slider-turn');
    const labelSpeed  = document.getElementById('label-speed');
    const labelTurn   = document.getElementById('label-turn');

    function sendLimits(){
      if(!isConnected) return;
      const max_speed = parseFloat(sliderSpeed.value);
      const max_turn  = parseFloat(sliderTurn.value);
      labelSpeed.textContent = max_speed.toFixed(2);
      labelTurn.textContent  = max_turn.toFixed(2);
      ws.send(JSON.stringify({type:'config', max_speed, max_turn}));
    }
    ['input','change'].forEach(ev=>{
      sliderSpeed.addEventListener(ev, sendLimits);
      sliderTurn.addEventListener(ev, sendLimits);
    });

    // ── 수동 이동
    const SPEED_BTN=0.10, TURN_BTN=0.35;
    function sendCmd(linear, angular){
      if(!isConnected) return;
      ws.send(JSON.stringify({type:'cmd_vel', linear, angular}));
    }
    document.querySelectorAll('[data-cmd]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const c=btn.dataset.cmd; let lin=0, ang=0;
        if (c==='forward') lin = SPEED_BTN;
        if (c==='backward') lin = -SPEED_BTN;
        if (c==='left')    ang =  TURN_BTN;
        if (c==='right')   ang = -TURN_BTN;
        if (c==='stop')    {lin=0;ang=0;}
        sendCmd(lin,ang);
      });
    });
    window.addEventListener('keydown',(e)=>{
      const k=e.key.toLowerCase(); let lin=0, ang=0, ok=true;
      if(k==='w') lin= SPEED_BTN; else if(k==='s') lin=-SPEED_BTN;
      else if(k==='a') ang= TURN_BTN; else if(k==='d') ang=-TURN_BTN;
      else if(k===' ') {lin=0; ang=0;}
      else ok=false;
      if(오케이) sendCmd(lin,ang);
    });

    // ── 순찰 제어
    document.querySelectorAll('[data-patrol]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        if(!isConnected) return;
        const action = btn.dataset.patrol; // start/pause/return
        ws.send(JSON.stringify({type:'patrol', action}));
      });
    });
    document.getElementById('btn-ack').addEventListener('click', ()=>{
      if(!isConnected) return;
      ws.send(JSON.stringify({type:'security_ack'}));
    });

    // ── init
    window.onload = connectWS;
  </script>
</body>
</html>
